Object.defineProperty(exports, '__esModule', {
  value: true
});

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.getDefaultConnectionProfile = getDefaultConnectionProfile;
exports.getSavedConnectionProfiles = getSavedConnectionProfiles;
exports.saveConnectionProfiles = saveConnectionProfiles;
exports.onSavedConnectionProfilesDidChange = onSavedConnectionProfilesDidChange;
exports.getSavedConnectionConfig = getSavedConnectionConfig;
exports.saveConnectionConfig = saveConnectionConfig;
exports.getDefaultConfig = getDefaultConfig;
exports.getOfficialRemoteServerCommand = getOfficialRemoteServerCommand;

// $UPFixMe: These settings should go through nuclide-feature-config
var CONNECTION_PROFILES_KEY = 'nuclide.connectionProfiles';
var LAST_USED_CONNECTION_KEY = 'nuclide.lastConnectionDetails';

/**
 * Section: Default Connection Profile
 */

/**
 * A default connection profile is a combination of the user's last inputs to
 * the connection dialog and the default settings, plus the update logic we use
 * to change the remote server command.
 */

function getDefaultConnectionProfile() {
  var defaultConnectionSettings = getDefaultConfig();
  var currentOfficialRSC = defaultConnectionSettings.remoteServerCommand;

  var lastConnectionDetails = getSavedConnectionConfig() || {};
  var lastConfig = lastConnectionDetails.config || {};

  // Only use the user's last saved remote server command if there has been no
  // change (upgrade) in the official remote server command.
  var remoteServerCommand = currentOfficialRSC;
  if (lastConnectionDetails.lastOfficialRemoteServerCommand === currentOfficialRSC && lastConfig.remoteServerCommand) {
    remoteServerCommand = lastConfig.remoteServerCommand;
  }
  var dialogSettings = _extends({}, defaultConnectionSettings, lastConfig, { remoteServerCommand: remoteServerCommand });
  // Due to a previous bug in the sshPort type, we may need to do this cast to
  // correct bad state that was persisted in users' configs.
  dialogSettings.sshPort = String(dialogSettings.sshPort);
  return {
    deletable: false,
    displayTitle: '(default)',
    params: dialogSettings
  };
}

/**
 * Section: User-created Connection Profiles
 */

/**
 * Returns an array of saved connection profiles.
 */

function getSavedConnectionProfiles() {
  var connectionProfiles = atom.config.get(CONNECTION_PROFILES_KEY);
  prepareSavedConnectionProfilesForDisplay(connectionProfiles);
  return connectionProfiles || [];
}

/**
 * Saves the connection profiles. Overwrites any existing profiles.
 */

function saveConnectionProfiles(profiles) {
  prepareConnectionProfilesForSaving(profiles);
  atom.config.set(CONNECTION_PROFILES_KEY, profiles);
}

/**
 * Calls the callback when the saved connection profiles change.
 * @return Disposable that can be disposed to stop listening for changes.
 */

function onSavedConnectionProfilesDidChange(callback) {
  return atom.config.onDidChange(CONNECTION_PROFILES_KEY, function (event) {
    var newProfiles = event.newValue;
    prepareSavedConnectionProfilesForDisplay(newProfiles);
    callback(newProfiles);
  });
}

/**
 * Section: Default/Last-Used Connection Profiles
 */

/**
 * Gets the NuclideSavedConnectionDialogConfig representing the user's last
 * connection.
 */

function getSavedConnectionConfig() {
  var savedConfig = atom.config.get(LAST_USED_CONNECTION_KEY);
  return savedConfig;
}

/**
 * Saves a connection configuration along with the last official server command.
 */

function saveConnectionConfig(config, lastOfficialRemoteServerCommand) {
  // Don't store user's password.
  var updatedConfig = _extends({}, config, { password: '' });
  // SshConnectionConfiguration's sshPort type is 'number', but we want to save
  // everything as strings.
  updatedConfig.sshPort = String(config.sshPort);
  atom.config.set(LAST_USED_CONNECTION_KEY, {
    updatedConfig: updatedConfig,
    // Save last official command to detect upgrade.
    lastOfficialRemoteServerCommand: lastOfficialRemoteServerCommand
  });
}

var defaultConfig = null;
/**
 * This fetches the 'default' connection configuration supplied to the user
 * regardless of any connection profiles they might have saved.
 */

function getDefaultConfig() {
  if (defaultConfig) {
    return defaultConfig;
  }
  var defaultConfigGetter = undefined;
  try {
    defaultConfigGetter = require('./fb/config');
  } catch (e) {
    defaultConfigGetter = require('./config');
  }
  defaultConfig = defaultConfigGetter.getConnectionDialogDefaultSettings();
  return defaultConfig;
}

function getOfficialRemoteServerCommand() {
  return getDefaultConfig().remoteServerCommand;
}

function prepareSavedConnectionProfilesForDisplay(connectionProfiles) {
  if (!connectionProfiles) {
    return;
  }
  // If a profile does not inclide a remote server command, this means the user
  // intended to use the default server command. We must fill this in.
  var defaultConnectionSettings = getDefaultConfig();
  var currentOfficialRSC = defaultConnectionSettings.remoteServerCommand;
  connectionProfiles.forEach(function (profile) {
    if (!profile.params.remoteServerCommand) {
      profile.params.remoteServerCommand = currentOfficialRSC;
    }
  });
}

function prepareConnectionProfilesForSaving(connectionProfiles) {
  // If a connection profile has a default remote server command, replace it with
  // an empty string. This indicates that this server command should be filled in
  // when this profile is used.
  var defaultConnectionSettings = getDefaultConfig();
  var currentOfficialRSC = defaultConnectionSettings.remoteServerCommand;
  connectionProfiles.forEach(function (profile) {
    if (profile.params.remoteServerCommand === currentOfficialRSC) {
      profile.params.remoteServerCommand = '';
    }
  });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbm5lY3Rpb24tcHJvZmlsZS11dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxQkEsSUFBTSx1QkFBdUIsR0FBRyw0QkFBNEIsQ0FBQztBQUM3RCxJQUFNLHdCQUF3QixHQUFHLCtCQUErQixDQUFDOzs7Ozs7Ozs7Ozs7QUFXMUQsU0FBUywyQkFBMkIsR0FBbUM7QUFDNUUsTUFBTSx5QkFBeUIsR0FBRyxnQkFBZ0IsRUFBRSxDQUFDO0FBQ3JELE1BQU0sa0JBQWtCLEdBQUcseUJBQXlCLENBQUMsbUJBQW1CLENBQUM7O0FBRXpFLE1BQU0scUJBQXFCLEdBQUcsd0JBQXdCLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDL0QsTUFBTSxVQUFVLEdBQUcscUJBQXFCLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQzs7OztBQUl0RCxNQUFJLG1CQUFtQixHQUFHLGtCQUFrQixDQUFDO0FBQzdDLE1BQUkscUJBQXFCLENBQUMsK0JBQStCLEtBQUssa0JBQWtCLElBQ3pFLFVBQVUsQ0FBQyxtQkFBbUIsRUFBRTtBQUNyQyx1QkFBbUIsR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUM7R0FDdEQ7QUFDRCxNQUFNLGNBQWMsZ0JBQU8seUJBQXlCLEVBQUssVUFBVSxJQUFFLG1CQUFtQixFQUFuQixtQkFBbUIsR0FBQyxDQUFDOzs7QUFHMUYsZ0JBQWMsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN4RCxTQUFPO0FBQ0wsYUFBUyxFQUFFLEtBQUs7QUFDaEIsZ0JBQVksRUFBRSxXQUFXO0FBQ3pCLFVBQU0sRUFBRSxjQUFjO0dBQ3ZCLENBQUM7Q0FDSDs7Ozs7Ozs7OztBQVVNLFNBQVMsMEJBQTBCLEdBQTBDO0FBQ2xGLE1BQU0sa0JBQTBELEdBQzdELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLEFBQU0sQ0FBQztBQUNsRCwwQ0FBd0Ms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QW1CLEtBQUssa0JBQWtCLEVBQUU7QUFDN0QsYUFBTyxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsR0FBRyxFQUFFLENBQUM7S0FDekM7R0FDRixDQUFDLENBQUM7Q0FDSiIsImZpbGUiOiJjb25uZWN0aW9uLXByb2ZpbGUtdXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7XG4gIE51Y2xpZGVSZW1vdGVDb25uZWN0aW9uUHJvZmlsZSxcbiAgTnVjbGlkZVNhdmVkQ29ubmVjdGlvbkRpYWxvZ0NvbmZpZyxcbn0gZnJvbSAnLi9jb25uZWN0aW9uLXR5cGVzJztcblxuaW1wb3J0IHR5cGUge1xuICBTc2hDb25uZWN0aW9uQ29uZmlndXJhdGlvbixcbn0gZnJvbSAnLi4vLi4vcmVtb3RlLWNvbm5lY3Rpb24vbGliL1NzaEhhbmRzaGFrZSc7XG5cbi8vICRVUEZpeE1lOiBUaGVzZSBzZXR0aW5ncyBzaG91bGQgZ28gdGhyb3VnaCBudWNsaWRlLWZlYXR1cmUtY29uZmlnXG5jb25zdCBDT05ORUNUSU9OX1BST0ZJTEVTX0tFWSA9ICdudWNsaWRlLmNvbm5lY3Rpb25Qcm9maWxlcyc7XG5jb25zdCBMQVNUX1VTRURfQ09OTkVDVElPTl9LRVkgPSAnbnVjbGlkZS5sYXN0Q29ubmVjdGlvbkRldGFpbHMnO1xuXG4vKipcbiAqIFNlY3Rpb246IERlZmF1bHQgQ29ubmVjdGlvbiBQcm9maWxlXG4gKi9cblxuLyoqXG4gKiBBIGRlZmF1bHQgY29ubmVjdGlvbiBwcm9maWxlIGlzIGEgY29tYmluYXRpb24gb2YgdGhlIHVzZXIncyBsYXN0IGlucHV0cyB0b1xuICogdGhlIGNvbm5lY3Rpb24gZGlhbG9nIGFuZCB0aGUgZGVmYXVsdCBzZXR0aW5ncywgcGx1cyB0aGUgdXBkYXRlIGxvZ2ljIHdlIHVzZVxuICogdG8gY2hhbmdlIHRoZSByZW1vdGUgc2VydmVyIGNvbW1hbmQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0Q29ubmVjdGlvblByb2ZpbGUoKTogTnVjbGlkZVJlbW90ZUNvbm5lY3Rpb25Qcm9maWxlIHtcbiAgY29uc3QgZGVmYXVsdENvbm5lY3Rpb25TZXR0aW5ncyA9IGdldERlZmF1bHRDb25maWcoKTtcbiAgY29uc3QgY3VycmVudE9mZmljaWFsUlNDID0gZGVmYXVsdENvbm5lY3Rpb25TZXR0aW5ncy5yZW1vdGVTZXJ2ZXJDb21tYW5kO1xuXG4gIGNvbnN0IGxhc3RDb25uZWN0aW9uRGV0YWlscyA9IGdldFNhdmVkQ29ubmVjdGlvbkNvbmZpZygpIHx8IHt9O1xuICBjb25zdCBsYXN0Q29uZmlnID0gbGFzdENvbm5lY3Rpb25EZXRhaWxzLmNvbmZpZyB8fCB7fTtcblxuICAvLyBPbmx5IHVzZSB0aGUgdXNlcidzIGxhc3Qgc2F2ZWQgcmVtb3RlIHNlcnZlciBjb21tYW5kIGlmIHRoZXJlIGhhcyBiZWVuIG5vXG4gIC8vIGNoYW5nZSAodXBncmFkZSkgaW4gdGhlIG9mZmljaWFsIHJlbW90ZSBzZXJ2ZXIgY29tbWFuZC5cbiAgbGV0IHJlbW90ZVNlcnZlckNvbW1hbmQgPSBjdXJyZW50T2ZmaWNpYWxSU0M7XG4gIGlmIChsYXN0Q29ubmVjdGlvbkRldGFpbHMubGFzdE9mZmljaWFsUmVtb3RlU2VydmVyQ29tbWFuZCA9PT0gY3VycmVudE9mZmljaWFsUlNDXG4gICAgICAmJiBsYXN0Q29uZmlnLnJlbW90ZVNlcnZlckNvbW1hbmQpIHtcbiAgICByZW1vdGVTZXJ2ZXJDb21tYW5kID0gbGFzdENvbmZpZy5yZW1vdGVTZXJ2ZXJDb21tYW5kO1xuICB9XG4gIGNvbnN0IGRpYWxvZ1NldHRpbmdzID0gey4uLmRlZmF1bHRDb25uZWN0aW9uU2V0dGluZ3MsIC4uLmxhc3RDb25maWcsIHJlbW90ZVNlcnZlckNvbW1hbmR9O1xuICAvLyBEdWUgdG8gYSBwcmV2aW91cyBidWcgaW4gdGhlIHNzaFBvcnQgdHlwZSwgd2UgbWF5IG5lZWQgdG8gZG8gdGhpcyBjYXN0IHRvXG4gIC8vIGNvcnJlY3QgYmFkIHN0YXRlIHRoYXQgd2FzIHBlcnNpc3RlZCBpbiB1c2VycycgY29uZmlncy5cbiAgZGlhbG9nU2V0dGluZ3Muc3NoUG9ydCA9IFN0cmluZyhkaWFsb2dTZXR0aW5ncy5zc2hQb3J0KTtcbiAgcmV0dXJuIHtcbiAgICBkZWxldGFibGU6IGZhbHNlLFxuICAgIGRpc3BsYXlUaXRsZTogJyhkZWZhdWx0KScsXG4gICAgcGFyYW1zOiBkaWFsb2dTZXR0aW5ncyxcbiAgfTtcbn1cblxuXG4vKipcbiAqIFNlY3Rpb246IFVzZXItY3JlYXRlZCBDb25uZWN0aW9uIFByb2ZpbGVzXG4gKi9cblxuLyoqXG4gKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNhdmVkIGNvbm5lY3Rpb24gcHJvZmlsZXMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTYXZlZENvbm5lY3Rpb25Qcm9maWxlcygpOiBBcnJheTxOdWNsaWRlUmVtb3RlQ29ubmVjdGlvblByb2ZpbGU+IHtcbiAgY29uc3QgY29ubmVjdGlvblByb2ZpbGVzOiA/QXJyYXk8TnVjbGlkZVJlbW90ZUNvbm5lY3Rpb25Qcm9maWxlPiA9XG4gICAgKGF0b20uY29uZmlnLmdldChDT05ORUNUSU9OX1BST0ZJTEVTX0tFWSk6IGFueSk7XG4gIHByZXBhcmVTYXZlZENvbm5lY3Rpb25Qcm9maWxlc0ZvckRpc3BsYXkoY29ubmVjdGlvblByb2ZpbGVzKTtcbiAgcmV0dXJuIGNvbm5lY3Rpb25Qcm9maWxlcyB8fCBbXTtcbn1cblxuLyoqXG4gKiBTYXZlcyB0aGUgY29ubmVjdGlvbiBwcm9maWxlcy4gT3ZlcndyaXRlcyBhbnkgZXhpc3RpbmcgcHJvZmlsZXMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzYXZlQ29ubmVjdGlvblByb2ZpbGVzKHByb2ZpbGVzOiBBcnJheTxOdWNsaWRlUmVtb3RlQ29ubmVjdGlvblByb2ZpbGU+KTogdm9pZCB7XG4gIHByZXBhcmVDb25uZWN0aW9uUHJvZmlsZXNGb3JTYXZpbmcocHJvZmlsZXMpO1xuICBhdG9tLmNvbmZpZy5zZXQoQ09OTkVDVElPTl9QUk9GSUxFU19LRVksIHByb2ZpbGVzKTtcbn1cblxuXG50eXBlIENvbm5lY3Rpb25Qcm9maWxlQ2hhbmdlID0ge1xuICBuZXdWYWx1ZTogP0FycmF5PE51Y2xpZGVSZW1vdGVDb25uZWN0aW9uUHJvZmlsZT47XG4gIG9sZFZhbHVlOiA/QXJyYXk8TnVjbGlkZVJlbW90ZUNvbm5lY3Rpb25Qcm9maWxlPjtcbiAga2V5UGF0aDogc3RyaW5nO1xufTtcbi8qKlxuICogQ2FsbHMgdGhlIGNhbGxiYWNrIHdoZW4gdGhlIHNhdmVkIGNvbm5lY3Rpb24gcHJvZmlsZXMgY2hhbmdlLlxuICogQHJldHVybiBEaXNwb3NhYmxlIHRoYXQgY2FuIGJlIGRpc3Bvc2VkIHRvIHN0b3AgbGlzdGVuaW5nIGZvciBjaGFuZ2VzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gb25TYXZlZENvbm5lY3Rpb25Qcm9maWxlc0RpZENoYW5nZShcbiAgY2FsbGJhY2s6IChuZXdQcm9maWxlczogP0FycmF5PE51Y2xpZGVSZW1vdGVDb25uZWN0aW9uUHJvZmlsZT4pID0+IG1peGVkXG4pOiBJRGlzcG9zYWJsZSB7XG4gIHJldHVybiBhdG9tLmNvbmZpZy5vbkRpZENoYW5nZShcbiAgICBDT05ORUNUSU9OX1BST0ZJTEVTX0tFWSxcbiAgICAoZXZlbnQ6IENvbm5lY3Rpb25Qcm9maWxlQ2hhbmdlKSA9PiB7XG4gICAgICBjb25zdCBuZXdQcm9maWxlcyA9IGV2ZW50Lm5ld1ZhbHVlO1xuICAgICAgcHJlcGFyZVNhdmVkQ29ubmVjdGlvblByb2ZpbGVzRm9yRGlzcGxheShuZXdQcm9maWxlcyk7XG4gICAgICBjYWxsYmFjayhuZXdQcm9maWxlcyk7XG4gICAgfVxuICApO1xufVxuXG5cbi8qKlxuICogU2VjdGlvbjogRGVmYXVsdC9MYXN0LVVzZWQgQ29ubmVjdGlvbiBQcm9maWxlc1xuICovXG5cbi8qKlxuICogR2V0cyB0aGUgTnVjbGlkZVNhdmVkQ29ubmVjdGlvbkRpYWxvZ0NvbmZpZyByZXByZXNlbnRpbmcgdGhlIHVzZXIncyBsYXN0XG4gKiBjb25uZWN0aW9uLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2F2ZWRDb25uZWN0aW9uQ29uZmlnKCk6ID9OdWNsaWRlU2F2ZWRDb25uZWN0aW9uRGlhbG9nQ29uZmlnIHtcbiAgY29uc3Qgc2F2ZWRDb25maWc6IGFueSA9IGF0b20uY29uZmlnLmdldChMQVNUX1VTRURfQ09OTkVDVElPTl9LRVkpO1xuICByZXR1cm4gKHNhdmVkQ29uZmlnIDogP051Y2xpZGVTYXZlZENvbm5lY3Rpb25EaWFsb2dDb25maWcpO1xufVxuXG4vKipcbiAqIFNhdmVzIGEgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIGFsb25nIHdpdGggdGhlIGxhc3Qgb2ZmaWNpYWwgc2VydmVyIGNvbW1hbmQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzYXZlQ29ubmVjdGlvbkNvbmZpZyhcbiAgY29uZmlnOiBTc2hDb25uZWN0aW9uQ29uZmlndXJhdGlvbixcbiAgbGFzdE9mZmljaWFsUmVtb3RlU2VydmVyQ29tbWFuZDogc3RyaW5nXG4pOiB2b2lkIHtcbiAgLy8gRG9uJ3Qgc3RvcmUgdXNlcidzIHBhc3N3b3JkLlxuICBjb25zdCB1cGRhdGVkQ29uZmlnID0gey4uLmNvbmZpZywgcGFzc3dvcmQ6ICcnfTtcbiAgLy8gU3NoQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24ncyBzc2hQb3J0IHR5cGUgaXMgJ251bWJlcicsIGJ1dCB3ZSB3YW50IHRvIHNhdmVcbiAgLy8gZXZlcnl0aGluZyBhcyBzdHJpbmdzLlxuICB1cGRhdGVkQ29uZmlnLnNzaFBvcnQgPSBTdHJpbmcoY29uZmlnLnNzaFBvcnQpO1xuICBhdG9tLmNvbmZpZy5zZXQoTEFTVF9VU0VEX0NPTk5FQ1RJT05fS0VZLCB7XG4gICAgdXBkYXRlZENvbmZpZyxcbiAgICAvLyBTYXZlIGxhc3Qgb2ZmaWNpYWwgY29tbWFuZCB0byBkZXRlY3QgdXBncmFkZS5cbiAgICBsYXN0T2ZmaWNpYWxSZW1vdGVTZXJ2ZXJDb21tYW5kLFxuICB9KTtcbn1cblxubGV0IGRlZmF1bHRDb25maWc6ID9hbnkgPSBudWxsO1xuLyoqXG4gKiBUaGlzIGZldGNoZXMgdGhlICdkZWZhdWx0JyBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24gc3VwcGxpZWQgdG8gdGhlIHVzZXJcbiAqIHJlZ2FyZGxlc3Mgb2YgYW55IGNvbm5lY3Rpb24gcHJvZmlsZXMgdGhleSBtaWdodCBoYXZlIHNhdmVkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdENvbmZpZygpOiBhbnkge1xuICBpZiAoZGVmYXVsdENvbmZpZykge1xuICAgIHJldHVybiBkZWZhdWx0Q29uZmlnO1xuICB9XG4gIGxldCBkZWZhdWx0Q29uZmlnR2V0dGVyO1xuICB0cnkge1xuICAgIGRlZmF1bHRDb25maWdHZXR0ZXIgPSByZXF1aXJlKCcuL2ZiL2NvbmZpZycpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgZGVmYXVsdENvbmZpZ0dldHRlciA9IHJlcXVpcmUoJy4vY29uZmlnJyk7XG4gIH1cbiAgZGVmYXVsdENvbmZpZyA9IGRlZmF1bHRDb25maWdHZXR0ZXIuZ2V0Q29ubmVjdGlvbkRpYWxvZ0RlZmF1bHRTZXR0aW5ncygpO1xuICByZXR1cm4gZGVmYXVsdENvbmZpZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9mZmljaWFsUmVtb3RlU2VydmVyQ29tbWFuZCgpOiBzdHJpbmcge1xuICByZXR1cm4gZ2V0RGVmYXVsdENvbmZpZygpLnJlbW90ZVNlcnZlckNvbW1hbmQ7XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVTYXZlZENvbm5lY3Rpb25Qcm9maWxlc0ZvckRpc3BsYXkoXG4gIGNvbm5lY3Rpb25Qcm9maWxlczogP0FycmF5PE51Y2xpZGVSZW1vdGVDb25uZWN0aW9uUHJvZmlsZT4sXG4pOiB2b2lkIHtcbiAgaWYgKCFjb25uZWN0aW9uUHJvZmlsZXMpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgLy8gSWYgYSBwcm9maWxlIGRvZXMgbm90IGluY2xpZGUgYSByZW1vdGUgc2VydmVyIGNvbW1hbmQsIHRoaXMgbWVhbnMgdGhlIHVzZXJcbiAgLy8gaW50ZW5kZWQgdG8gdXNlIHRoZSBkZWZhdWx0IHNlcnZlciBjb21tYW5kLiBXZSBtdXN0IGZpbGwgdGhpcyBpbi5cbiAgY29uc3QgZGVmYXVsdENvbm5lY3Rpb25TZXR0aW5ncyA9IGdldERlZmF1bHRDb25maWcoKTtcbiAgY29uc3QgY3VycmVudE9mZmljaWFsUlNDID0gZGVmYXVsdENvbm5lY3Rpb25TZXR0aW5ncy5yZW1vdGVTZXJ2ZXJDb21tYW5kO1xuICBjb25uZWN0aW9uUHJvZmlsZXMuZm9yRWFjaCgocHJvZmlsZTogTnVjbGlkZVJlbW90ZUNvbm5lY3Rpb25Qcm9maWxlKSA9PiB7XG4gICAgaWYgKCFwcm9maWxlLnBhcmFtcy5yZW1vdGVTZXJ2ZXJDb21tYW5kKSB7XG4gICAgICBwcm9maWxlLnBhcmFtcy5yZW1vdGVTZXJ2ZXJDb21tYW5kID0gY3VycmVudE9mZmljaWFsUlNDO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVDb25uZWN0aW9uUHJvZmlsZXNGb3JTYXZpbmcoXG4gIGNvbm5lY3Rpb25Qcm9maWxlczogQXJyYXk8TnVjbGlkZVJlbW90ZUNvbm5lY3Rpb25Qcm9maWxlPlxuKTogdm9pZCB7XG4gIC8vIElmIGEgY29ubmVjdGlvbiBwcm9maWxlIGhhcyBhIGRlZmF1bHQgcmVtb3RlIHNlcnZlciBjb21tYW5kLCByZXBsYWNlIGl0IHdpdGhcbiAgLy8gYW4gZW1wdHkgc3RyaW5nLiBUaGlzIGluZGljYXRlcyB0aGF0IHRoaXMgc2VydmVyIGNvbW1hbmQgc2hvdWxkIGJlIGZpbGxlZCBpblxuICAvLyB3aGVuIHRoaXMgcHJvZmlsZSBpcyB1c2VkLlxuICBjb25zdCBkZWZhdWx0Q29ubmVjdGlvblNldHRpbmdzID0gZ2V0RGVmYXVsdENvbmZpZygpO1xuICBjb25zdCBjdXJyZW50T2ZmaWNpYWxSU0MgPSBkZWZhdWx0Q29ubmVjdGlvblNldHRpbmdzLnJlbW90ZVNlcnZlckNvbW1hbmQ7XG4gIGNvbm5lY3Rpb25Qcm9maWxlcy5mb3JFYWNoKChwcm9maWxlOiBOdWNsaWRlUmVtb3RlQ29ubmVjdGlvblByb2ZpbGUpID0+IHtcbiAgICBpZiAocHJvZmlsZS5wYXJhbXMucmVtb3RlU2VydmVyQ29tbWFuZCA9PT0gY3VycmVudE9mZmljaWFsUlNDKSB7XG4gICAgICBwcm9maWxlLnBhcmFtcy5yZW1vdGVTZXJ2ZXJDb21tYW5kID0gJyc7XG4gICAgfVxuICB9KTtcbn1cbiJdfQ==